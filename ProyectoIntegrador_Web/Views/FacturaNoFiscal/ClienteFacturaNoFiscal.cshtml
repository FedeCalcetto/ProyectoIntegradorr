 @using ProyectoIntegrador.LogicaNegocio.Entidades
@model FacturaNoFiscalCliente
@Html.AntiForgeryToken()

@if (Model == null)
{
    <h3>No se encontró la factura.</h3>
    return;
}
<h2>Factura no fiscal</h2>

<p>
    Esta factura muestra únicamente datos relacionados a su compra.
    Es realizada a modo de prueba.
</p>

<div class="card mb-3">
    <div class="card-body">
        <h5>Cliente: @Model.Cliente?.nombre</h5>

        <h5 class="mt-4">Detalle de la compra</h5>

        <div class="table-responsive">
            <table class="table table-bordered table-striped align-middle">
                <thead class="table-dark">
                    <tr>
                        <th>Producto</th>
                        <th>Artesano</th>
                        <th>Precio unitario</th>
                        <th>Cantidad</th>
                        <th>Subtotal</th>
                        <th>Calificar</th>
                    </tr>
                </thead>
                <tbody>
                    @if (Model.itemsFactura != null && Model.itemsFactura.Any())
                    {
                        foreach (var grupo in Model.itemsFactura
                        .GroupBy(i => new { i.NombreProducto, i.precioUnitario, i.NombreArtesano }))
                        {
                            var item = grupo.First();
                            var cantidadTotal = grupo.Sum(i => i.cantidad);
                            var subtotal = cantidadTotal * item.precioUnitario;

                            <tr>
                                <td>@item.NombreProducto</td>
                                <td>@item.NombreArtesano</td>
                                <td>$@item.precioUnitario</td>
                                <td>@cantidadTotal</td>
                                <td>$@subtotal</td>
                                <td>
                                    <div class="rating"
                                         data-producto="@item.idProducto">

                                        @for (int i = 1; i <= 5; i++)
                                        {
                                            <i class="bi bi-star star-click"
                                               data-value="@i"
                                               style="cursor:pointer; font-size:1.3rem;"></i>
                                        }

                                    </div>
                                </td>
                            </tr>
                        }
                    }
                    else
                    {
                        <tr>
                            <td colspan="5" class="text-center">
                                Esta factura no tiene ítems.
                            </td>
                        </tr>
                    }
                </tbody>
            </table>
        </div>

        <div class="text-end mt-3">
            <h5>Total pagado: <strong>$@Model.Total</strong></h5>
            <p>Fecha: @Model.Fecha.ToString("dd/MM/yyyy")</p>
        </div>

        <a class="btn btn-primary mt-3"
           asp-action="PDFCliente"
           asp-route-id="@Model.Id">
            Descargar PDF
        </a>
    </div>
</div>

<script>
    document.querySelectorAll(".star-click").forEach(star => {

        star.addEventListener("click", function () {

            const puntaje = this.getAttribute("data-value");
            const container = this.closest(".rating");
            const productoId = container.getAttribute("data-producto");

            fetch('/Producto/Calificar', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'RequestVerificationToken':
                        document.querySelector('input[name="__RequestVerificationToken"]').value
                },
                body: JSON.stringify({
                    productoId: parseInt(productoId),
                    puntaje: parseInt(puntaje)
                })
            })
            .then(response => {
                if (response.ok) {
                    pintarEstrellas(container, puntaje);
                    alert("Gracias por calificar ⭐");
                } else {
                    alert("No se pudo calificar.");
                }
            });
        });
    });

    function pintarEstrellas(container, puntaje) {

        const stars = container.querySelectorAll(".star-click");

        stars.forEach(star => {

            if (star.getAttribute("data-value") <= puntaje) {
                star.classList.remove("bi-star");
                star.classList.add("bi-star-fill", "text-warning");
            } else {
                star.classList.remove("bi-star-fill");
                star.classList.add("bi-star");
            }

        });
    }
</script>