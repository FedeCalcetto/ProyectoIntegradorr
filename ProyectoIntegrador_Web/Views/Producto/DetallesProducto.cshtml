@model DetallesProductoViewModel

@{
    ViewData["Title"] = "Detalle del producto";
}

<div class="container mt-5">
    @if (TempData.Peek("Success") != null)
    {
        <div class="alert alert-success alert-dismissible fade show" role="alert">
            @TempData.Peek("Success")
            <button type="button"
                    class="btn-close"
                    data-bs-dismiss="alert"></button>
        </div>
    }
    <div class="card shadow-sm p-4">

        <!-- Breadcrumb -->
        <nav class="mb-3">
            <small class="text-muted">
                Catálogo / @Model.SubCategoria / @Model.Nombre
            </small>
        </nav>

        <div class="row g-4 align-items-start">

            <!-- MINIATURAS -->
            <div class="col-md-1 d-flex flex-column align-items-center gap-2">
                @foreach (var foto in Model.Fotos)
                {
                    <img src="~/images/productos/@foto.UrlImagen"
                         class="img-thumbnail thumb-img"
                         style="width:60px; cursor:pointer"
                         onclick="cambiarImagen(this)" />
                }
            </div>

            <!-- IMAGEN PRINCIPAL -->
            <div class="col-md-4">
                <div class="border rounded shadow-sm p-3 text-center bg-white">
                    <img id="imagenPrincipal"
                         src="~/images/productos/@Model.Imagen"
                         class="img-fluid rounded"
                         style="max-height:420px; object-fit:contain;"
                         alt="@Model.Nombre" />
                </div>
            </div>

            <!-- INFO / COMPRA -->
            <div class="col-md-7">

                <h4 class="fw-semibold">@Model.Nombre</h4>

                <p class="text-muted small mb-2">
                    @Model.Descripcion
                </p>

                <div class="mb-3">
                    <span class="fs-3 fw-bold text-dark">
                        $@Model.Precio
                    </span>
                </div>

                <span class="badge bg-@(Model.Stock > 0 ? "success" : "danger") mb-3">
                    Stock disponible: @Model.Stock
                </span>

                <p class="mt-3 text-muted">
                    Vendido por
                    <strong>
                        <a href="#"
                           onclick="event.preventDefault(); alert('Perfil del artesano próximamente');">
                            @Model.Artesano
                        </a>
                    </strong>
                </p>

                @if (Model.Stock > 0)
                {
                    <form asp-controller="Carrito"
                          asp-action="AgregarAlCarrito"
                          method="post"
                          class="mt-3">

                        @Html.AntiForgeryToken()
                        <input type="hidden" name="productoId" value="@Model.Id" />

                        <div class="mb-3 w-50">
                            <label class="form-label small fw-semibold">
                                Cantidad
                            </label>
                            <input type="number"
                                   name="cantidad"
                                   class="form-control form-control-sm"
                                   value="1"
                                   min="1"
                                   max="@Model.Stock" />
                        </div>

                        <div class="d-flex gap-2">
                            <button type="submit" class="btn btn-primary">
                                🛒 Agregar al carrito
                            </button>

                            <a asp-controller="Usuario"
                               asp-action="Catalogo"
                               class="btn btn-outline-secondary">
                                Volver a la tienda
                            </a>
                        </div>
                    </form>
                }
                else
                {
                    <p class="text-danger fw-semibold mt-3">
                        Sin stock 😢
                    </p>
                }
            </div>

            <!-- FORMULARIO DE REPORTE -->
            <hr class="my-4" />

            <div class="mt-3">
                <h6 class="fw-semibold text-danger">Reportar este producto</h6>

                <form asp-controller="Producto"
                      asp-action="ReportarProducto"
                      method="post"
                      class="mt-2">

                    @Html.AntiForgeryToken()

                    <input type="hidden" asp-for="Id" />

                    <div class="mb-2">
                        <textarea asp-for="Reporte.razon"
                                  class="form-control form-control-sm"
                                  rows="3"
                                  placeholder="Describa el motivo del reporte"></textarea>

                        <span asp-validation-for="Reporte.razon"
                              class="text-danger small"></span>
                    </div>

                    <button type="submit"
                            class="btn btn-sm btn-outline-danger">
                        🚩 Reportar producto
                    </button>
                </form>
            </div>
        </div>
    </div>
</div>

<!-- SCRIPTS -->
<script>
    function cambiarImagen(element) {
        const principal = document.getElementById("imagenPrincipal");
        principal.src = element.src;

        document.querySelectorAll(".thumb-img")
            .forEach(img => img.classList.remove("active-thumb"));

        element.classList.add("active-thumb");
    }

    document.addEventListener("DOMContentLoaded", () => {
        const primera = document.querySelector(".thumb-img");
        if (primera) primera.classList.add("active-thumb");
    });
</script>

@section Scripts {
    <partial name="_ValidationScriptsPartial" />
}