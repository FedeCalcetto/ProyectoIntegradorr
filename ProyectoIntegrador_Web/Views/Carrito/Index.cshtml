@model CarritoViewModel

@{
    ViewData["Title"] = "Mi Carrito";
}

<div class="container mt-4">

    <div class="row align-items-start">
        <h3 class="text-center text-muted mb-4">Mi carrito</h3>

        <!--        COLUMNA IZQUIERDA     -->
        <div class="col-lg-8">

            @foreach (var item in Model.ItemsCarrito)
            {
                <div class="card mb-3 shadow-sm" style="border: 1px solid #e0e0e0;">
                    <div class="card-body">

                        <div class="d-flex align-items-center">

                            <!-- Imagen Producto -->
                            <img src="~/images/productos/@item.producto.imagen"
                                 style="width: 90px; height: 90px; object-fit: contain;"
                                 class="me-3" />

                            <!-- Datos -->
                            <div class="flex-grow-1">


                                <h5 class="fw-semibold mb-1 ps-0" style="font-size: 1.15rem;">
                                    @item.producto.nombre
                                </h5>

                                <p class="mb-0 ps-0">
                                    <span class="fw-medium">Cantidad:</span> @item.cantidad
                                </p>
                                    

                            </div>

                            <div class="d-flex flex-column justify-content-center align-items-end">

                                <p class="fw-semibold fs-5 mb-2">
                                    Subtotal: $@(item.cantidad* item.producto.precio)
                                </p>

                                <button type="button"
                                        class="btn btn-outline-danger btn-sm"
                                        data-bs-toggle="modal"
                                        data-bs-target="#modalEliminar"
                                        data-item-id="@item.id"
                                        data-max="@item.cantidad"
                                        data-producto="@item.producto.nombre">
                                    Eliminar
                                </button>

                            </div>

                        </div>

                    </div>
                </div>
            }
            
        </div>

        <!--         COLUMNA DERECHA     -->
        <div class="col-lg-4">

            <div class="card shadow-sm" style="border: 1px solid #e0e0e0;">
                <div class="card-body">

                    <h5 class="fw-bold mb-3">Detalles de la compra</h5>

                    <div class="d-flex justify-content-between mb-2">

                        Cantidad de productos: @Model.ItemsCarrito.Sum(i => i.cantidad)

                        <span class="fw-bold">
                            Total: $@Model.ItemsCarrito.Sum(i => i.cantidad * i.producto.precio)
                        </span>
                    </div>

                    <form asp-controller="Carrito"
                          asp-action="ContinuarCompra"
                          method="post">

                        <button type="submit"
                                class="btn btn-primary w-100 btn-lg mt-3">
                            Continuar compra
                        </button>
                    </form>


                    <a id="btnVolverATienda" asp-controller="Usuario"
                       asp-action="Catalogo"
                       class="btn btn-primary w-100 mt-3">
                        Volver a la tienda
                    </a>

                </div>
            </div>

        </div>

    </div>

</div>


<div class="row mt-4">
    <hr id="hrCarrito" class="my-5">
    <div class="col-12">
        <h5 class="text-muted mb-3">También te puede interesar</h5>

        <div class="interes-slider-container">
            @if (Model.ProductosDeInteres.Count > 0){
            <!-- Flecha izquierda -->
               <button class="slider-btn prev-btn">&#10094;</button>

                <div class="interes-slider-wrapper">
                <div id="interes-slider"
                         class="interes-product-slider">

                        @foreach (var producto in Model.ProductosDeInteres)
                        {
                            <a asp-controller="Producto"
                               asp-action="DetallesProducto"
                               asp-route-id="@producto.id"
                               class="text-decoration-none text-dark">

                                <div class="product-card factura-card card shadow-sm h-100">

                                    <img src="~/images/productos/@producto.imagen"
                                         class="card-img-top"
                                         style="height:160px; object-fit:contain;" />

                                    <div class="card-body text-center">
                                        <h6 class="mb-1">@producto.nombre</h6>
                                        <p class="fw-bold mb-0">$@producto.precio</p>
                                    </div>

                                </div>
                            </a>
                        }


                </div>
            </div>

            <!-- Flecha derecha -->
            <button class="slider-btn next-btn">&#10095;</button>
            }else{

            <h5 class="modal-title">No hay productos para mostrar</h5>

            }

        </div>
    </div>
</div>



<!--         MODAL ELIMINAR     -->
<div class="modal fade" id="modalEliminar" tabindex="-1">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content">

            <form asp-controller="Carrito"
                  asp-action="EliminarItemDelCarrito"
                  method="post">

                <div class="modal-header">
                    <h5 class="modal-title">Eliminar producto</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>

                <div class="modal-body">
                    <p id="nombreProducto"></p>

                    <input type="hidden" name="idItemCarrito" id="idItemCarrito" />

                    <label class="form-label">Cantidad a eliminar</label>
                    <input type="number"
                           name="cantidadABorrar"
                           id="cantidadABorrar"
                           class="form-control"
                           min="1" />
                </div>

                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">
                        Cancelar
                    </button>
                    <button type="submit" class="btn btn-danger">
                        Eliminar
                    </button>
                </div>

            </form>

        </div>
    </div>
</div>


<script>
    const modalEliminar = document.getElementById('modalEliminar');

    modalEliminar.addEventListener('show.bs.modal', function (event) {
        const button = event.relatedTarget;

        const itemId = button.getAttribute('data-item-id');
        const max = button.getAttribute('data-max');
        const producto = button.getAttribute('data-producto');

        document.getElementById('idItemCarrito').value = itemId;
        document.getElementById('cantidadABorrar').value = 1;
        document.getElementById('cantidadABorrar').max = max;
        document.getElementById('nombreProducto').innerText =
            `Producto: ${producto} (máx: ${max})`;
    });
</script>


<script>
    const slider = document.getElementById("interes-slider");
    const prev = document.querySelector(".prev-btn");
    const next = document.querySelector(".next-btn");
    const wrapper = document.querySelector(".interes-slider-wrapper");

    if (slider && prev && next && wrapper) {

        let currentScroll = 0;

        function getCardWidth() {
            const card = slider.querySelector(".product-card");
            return card ? card.offsetWidth + 20 : 0;
        }

        function updateArrows() {
            const maxScroll = slider.scrollWidth - wrapper.offsetWidth;

            prev.style.display = currentScroll <= 0 ? "none" : "flex";
            next.style.display = currentScroll >= maxScroll ? "none" : "flex";
        }

        next.addEventListener("click", () => {
            const cardWidth = getCardWidth();
            const maxScroll = slider.scrollWidth - wrapper.offsetWidth;

            if (currentScroll < maxScroll) {
                currentScroll += cardWidth;
                slider.style.transform = `translateX(-${currentScroll}px)`;
                updateArrows();
            }
        });

        prev.addEventListener("click", () => {
            const cardWidth = getCardWidth();

            if (currentScroll > 0) {
                currentScroll -= cardWidth;
                slider.style.transform = `translateX(-${currentScroll}px)`;
                updateArrows();
            }
        });

        updateArrows();
    }
</script>
